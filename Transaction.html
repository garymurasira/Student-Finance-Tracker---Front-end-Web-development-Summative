<!-- Transactions Page -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactions</title>
  <link rel="stylesheet" href="./styles/Transaction.css">
  <link rel="stylesheet" href="./styles/navbar.css">
</head>

<body>
  <nav>
    <span><img class="logo" src="./assets/logo.png" alt="logo" width="55px"></span>
    <h1>FinTrack</h1>

    <!-- Desktop Navigation Links -->
    <ul class="nav-links">
      <li><a href="./Dashboard.html">Dashboard</a></li>
      <li><a href="./Transaction.html" class="active">Transactions</a></li>
      <li><a href="./index.html">About</a></li>
      <li><a href="./Settings.html">Settings</a></li>
    </ul>

    <!-- Mobile Hamburger Menu -->
    <div class="hamburger-menu" id="hamburgerMenu" aria-label="Menu" role="button" tabindex="0">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="sliding-panel" id="slidingPanel">
      <div class="panel-header">
        <h2>Menu</h2>
        <button class="close-btn" id="closeBtn">&times;</button>
      </div>
      <ul class="menu-links">
        <li><a href="./Dashboard.html">Dashboard</a></li>
        <li><a href="./Transaction.html" class="active">Transactions</a></li>
        <li><a href="./index.html">About</a></li>
        <li><a href="./Settings.html">Settings</a></li>
      </ul>
    </div>
  </nav>
  <hr>

  <main class="container">
    <section class="search-section" aria-labelledby="search-heading">
      <h2 id="search-heading" class="visually-hidden">Search and Add Transactions</h2>
      <div class="search-container">
        <label for="searchInput" class="visually-hidden">Search transactions</label>
        <input type="search" name="search" id="searchInput" placeholder="Search transactions (regex supported)">
        <button class="add-button" id="addTransactionBtn">Add Transaction</button>
      </div>
    </section>

    <!-- Sliding Transaction Form -->
    <section class="transaction-form-container" id="transactionForm" aria-labelledby="form-title">
      <h3 id="form-title" class="visually-hidden">Transaction Form</h3>
      <div class="transaction-form">
        <h3 id="formTitle">Add New Transaction</h3>
        <input type="hidden" id="editTransactionId">
        <div class="form-group">
          <label for="description">Description:</label>
          <input type="text" id="description" placeholder="e.g., Lunch at cafeteria" required
            aria-describedby="descriptionError descriptionHint">
          <span class="error-message" id="descriptionError" role="alert" aria-live="polite"></span>
          <span id="descriptionHint" class="hint-text">No leading/trailing spaces, no duplicate words</span>
        </div>
        <div class="form-group">
          <label for="amount">Amount:</label>
          <input type="number" id="amount" step="0.01" min="0" placeholder="e.g., 12.50" required
            aria-describedby="amountError">
          <span class="error-message" id="amountError" role="alert" aria-live="polite"></span>
        </div>
        <div class="form-group">
          <label for="category">Category:</label>
          <select id="category" required aria-describedby="categoryError">
            <option value="">Select a category</option>
            <option value="Food">Food</option>
            <option value="Books">Books</option>
            <option value="Transport">Transport</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Fees">Fees</option>
            <option value="Custom">Custom (type your own)</option>
          </select>
          <span class="error-message" id="categoryError" role="alert" aria-live="polite"></span>
          <input type="text" id="customCategory" placeholder="Enter custom category"
            style="display: none; margin-top: 8px;" aria-describedby="customCategoryError">
          <span class="error-message" id="customCategoryError" role="alert" aria-live="polite"></span>
        </div>
        <div class="form-group">
          <label for="date">Date:</label>
          <input type="date" id="date" required aria-describedby="dateError">
          <span class="error-message" id="dateError" role="alert" aria-live="polite"></span>
        </div>
        <div class="form-buttons">
          <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
          <button type="submit" class="save-btn" id="saveBtn">Save Transaction</button>
        </div>
      </div>
    </section>

    <section class="sort-section" aria-labelledby="sort-heading">
      <h2 id="sort-heading" class="visually-hidden">Sort Transactions</h2>
      <div class="sort">
        <label for="sortSelect">Sort by:&nbsp;</label>
        <select id="sortSelect">
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="description-asc">Description (A-Z)</option>
          <option value="description-desc">Description (Z-A)</option>
          <option value="amount-desc">Price (High to Low)</option>
          <option value="amount-asc">Price (Low to High)</option>
        </select>
      </div>
    </section>

    <section class="transactions-section" id="transactionsContainer" aria-labelledby="transactions-heading">
      <h2 id="transactions-heading">Transactions</h2>
      <table class="transaction-table" id="transactionTable" aria-label="Transaction list">
        <thead>
          <tr>
            <th scope="col">Description</th>
            <th scope="col">Amount</th>
            <th scope="col">Category</th>
            <th scope="col">Date</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody id="transactionTableBody">
          <!-- Transactions will be rendered here dynamically -->
        </tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>&copy; 2026 FinTrack. All rights reserved.</p>
  </footer>


  <script src="Script/constants.js"></script>
  <script src="Script/data.js"></script>
  <script src="Script/statistics.js"></script>
  <script src="Script/settings.js"></script>
  <script src="Script/transactions.js"></script>
  <script src="Script/ui.js"></script>
  <script src="Script/state.js"></script>
  <script>
    // Transaction Page Functionality
    const addBtn = document.getElementById('addTransactionBtn');
    const formContainer = document.getElementById('transactionForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const categorySelect = document.getElementById('category');
    const customCategoryInput = document.getElementById('customCategory');
    const descriptionInput = document.getElementById('description');
    const descriptionError = document.getElementById('descriptionError');
    const amountError = document.getElementById('amountError');
    const categoryError = document.getElementById('categoryError');
    const customCategoryError = document.getElementById('customCategoryError');
    const dateError = document.getElementById('dateError');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const transactionTableBody = document.getElementById('transactionTableBody');
    const formTitle = document.getElementById('formTitle');
    const editTransactionId = document.getElementById('editTransactionId');

    let currentSort = 'date-desc';
    let searchPattern = '';

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize navbar
      if (window.AppStateUI) {
        AppStateUI.initNavbar();
      }

      // Wait for AppState to initialize
      setTimeout(() => {
        renderTransactions();
        setupEventListeners();
      }, 100);
    });

    function setupEventListeners() {
      // Toggle form visibility
      addBtn.addEventListener('click', () => {
        resetForm();
        formContainer.classList.toggle('active');
      });

      cancelBtn.addEventListener('click', () => {
        formContainer.classList.remove('active');
        resetForm();
      });

      // Show/hide custom category input
      categorySelect.addEventListener('change', () => {
        if (categorySelect.value === 'Custom') {
          customCategoryInput.style.display = 'block';
          customCategoryInput.required = true;
        } else {
          customCategoryInput.style.display = 'none';
          customCategoryInput.required = false;
          customCategoryInput.value = '';
        }
      });

      // Description validation
      descriptionInput.addEventListener('blur', validateDescription);
      descriptionInput.addEventListener('input', () => {
        if (descriptionError.style.display === 'block') {
          validateDescription();
        }
      });

      // Amount validation on blur
      document.getElementById('amount').addEventListener('blur', validateAmount);

      // Category validation on blur
      categorySelect.addEventListener('blur', validateCategory);

      // Custom category validation on blur
      customCategoryInput.addEventListener('blur', validateCustomCategory);

      // Date validation on blur
      document.getElementById('date').addEventListener('blur', validateDate);

      // Search functionality
      searchInput.addEventListener('input', (e) => {
        searchPattern = e.target.value;
        renderTransactions();
      });

      // Sort functionality
      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        renderTransactions();
      });

      // Save transaction
      saveBtn.addEventListener('click', saveTransaction);
    }

    // Validation functions with Regex
    function validateDescription() {
      const value = descriptionInput.value;

      // Check for empty or leading/trailing spaces
      const leadingTrailingRegex = /^\S.*\S$/;
      if (!leadingTrailingRegex.test(value) || value.length === 0) {
        showError(descriptionError, 'Description cannot be empty or have leading/trailing spaces');
        return false;
      }

      // Check for duplicate words (advanced regex)
      const duplicateWordRegex = /\b(\w+)\b\s+\b\1\b/i;
      if (duplicateWordRegex.test(value)) {
        showError(descriptionError, 'Description cannot have duplicate words');
        return false;
      }

      clearError(descriptionError);
      return true;
    }

    function validateAmount() {
      const value = document.getElementById('amount').value;

      // Valid currency regex - positive number with up to 2 decimal places
      const currencyRegex = /^[1-9]\d*(\.\d{1,2})?$|^0\.\d{1,2}$/;

      if (!value || parseFloat(value) <= 0) {
        showError(amountError, 'Please enter a valid amount greater than 0');
        return false;
      }

      if (!currencyRegex.test(value)) {
        showError(amountError, 'Amount must be a valid currency (e.g., 12.50)');
        return false;
      }

      clearError(amountError);
      return true;
    }

    function validateCategory() {
      if (!categorySelect.value) {
        showError(categoryError, 'Please select a category');
        return false;
      }
      clearError(categoryError);
      return true;
    }

    function validateCustomCategory() {
      if (categorySelect.value === 'Custom') {
        const value = customCategoryInput.value;

        // Category text validation - letters, spaces, hyphens only
        const categoryRegex = /^[a-zA-Z\s-]+$/;

        if (!value || value.trim().length === 0) {
          showError(customCategoryError, 'Custom category cannot be empty');
          return false;
        }

        if (!categoryRegex.test(value)) {
          showError(customCategoryError, 'Category can only contain letters, spaces, and hyphens');
          return false;
        }

        // Check for duplicate words
        const duplicateWordRegex = /\b(\w+)\b\s+\b\1\b/i;
        if (duplicateWordRegex.test(value)) {
          showError(customCategoryError, 'Category cannot have duplicate words');
          return false;
        }

        clearError(customCategoryError);
      }
      return true;
    }

    function validateDate() {
      const value = document.getElementById('date').value;

      // Valid date format YYYY-MM-DD
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;

      if (!value) {
        showError(dateError, 'Please select a date');
        return false;
      }

      if (!dateRegex.test(value)) {
        showError(dateError, 'Date must be in YYYY-MM-DD format');
        return false;
      }

      // Check if it's a valid date
      const dateObj = new Date(value);
      if (isNaN(dateObj.getTime())) {
        showError(dateError, 'Please enter a valid date');
        return false;
      }

      clearError(dateError);
      return true;
    }

    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
      element.previousElementSibling.style.borderColor = '#e74c3c';
    }

    function clearError(element) {
      element.textContent = '';
      element.style.display = 'none';
      if (element.previousElementSibling) {
        element.previousElementSibling.style.borderColor = '#ddd';
      }
    }

    function saveTransaction() {
      const description = descriptionInput.value;
      const amount = document.getElementById('amount').value;
      let category = categorySelect.value;
      const date = document.getElementById('date').value;
      const editId = editTransactionId.value;

      // Run all validations
      const isDescriptionValid = validateDescription();
      const isAmountValid = validateAmount();
      const isCategoryValid = validateCategory();
      const isCustomCategoryValid = validateCustomCategory();
      const isDateValid = validateDate();

      if (!isDescriptionValid || !isAmountValid || !isCategoryValid || !isCustomCategoryValid || !isDateValid) {
        return;
      }

      // Handle custom category
      if (category === 'Custom') {
        category = customCategoryInput.value.trim();
      }

      const transactionData = {
        description: description.trim(),
        amount: parseFloat(amount),
        category,
        date
      };

      if (editId) {
        // Update existing
        AppState.updateTransaction(editId, transactionData);
      } else {
        // Add new
        AppState.addTransaction(transactionData);
      }

      formContainer.classList.remove('active');
      resetForm();
      renderTransactions();
    }

    function resetForm() {
      descriptionInput.value = '';
      document.getElementById('amount').value = '';
      categorySelect.value = '';
      customCategoryInput.style.display = 'none';
      customCategoryInput.value = '';
      document.getElementById('date').value = '';
      editTransactionId.value = '';
      formTitle.textContent = 'Add New Transaction';

      // Clear all error messages
      descriptionError.textContent = '';
      descriptionError.style.display = 'none';
      amountError.textContent = '';
      amountError.style.display = 'none';
      categoryError.textContent = '';
      categoryError.style.display = 'none';
      customCategoryError.textContent = '';
      customCategoryError.style.display = 'none';
      dateError.textContent = '';
      dateError.style.display = 'none';

      descriptionInput.style.borderColor = '#ddd';
      document.getElementById('amount').style.borderColor = '#ddd';
      categorySelect.style.borderColor = '#ddd';
      customCategoryInput.style.borderColor = '#ddd';
      document.getElementById('date').style.borderColor = '#ddd';

      // Set today's date as default
      document.getElementById('date').valueAsDate = new Date();
    }

    function renderTransactions() {
      if (!window.AppState) {
        console.error('AppState not loaded');
        return;
      }

      // Get transactions based on search and sort
      let transactions = [];

      if (searchPattern) {
        transactions = AppState.searchTransactions(searchPattern);
      } else {
        transactions = AppState.getAllTransactions();
      }

      // Apply sorting
      const [sortBy, order] = currentSort.split('-');
      transactions = sortTransactions(transactions, sortBy, order);

      // Clear container
      transactionTableBody.innerHTML = '';

      if (transactions.length === 0) {
        transactionTableBody.innerHTML = '<tr><td colspan="5" class="no-transactions">No transactions found</td></tr>';
        return;
      }

      // Render each transaction as table row
      transactions.forEach(transaction => {
        const row = createTransactionRow(transaction, searchPattern);
        transactionTableBody.appendChild(row);
      });
    }

    function sortTransactions(transactions, sortBy, order) {
      return [...transactions].sort((a, b) => {
        let comparison = 0;

        switch (sortBy) {
          case 'date':
            comparison = new Date(a.date) - new Date(b.date);
            break;
          case 'amount':
            comparison = a.amount - b.amount;
            break;
          case 'description':
            comparison = a.description.localeCompare(b.description);
            break;
          default:
            comparison = new Date(a.date) - new Date(b.date);
        }

        return order === 'desc' ? -comparison : comparison;
      });
    }

    function highlightMatch(text, pattern) {
      if (!pattern || !text) return escapeHtml(text);

      try {
        const regex = new RegExp(`(${pattern})`, 'gi');
        const escaped = escapeHtml(text);
        return escaped.replace(regex, '<mark>$1</mark>');
      } catch (e) {
        return escapeHtml(text);
      }
    }

    function createTransactionRow(transaction, searchPattern = '') {
      const row = document.createElement('tr');
      row.setAttribute('data-id', transaction.id);

      const formattedAmount = AppState.formatCurrency(transaction.amount);
      const formattedDate = AppState.formatDate(transaction.date);

      row.innerHTML = `
        <td data-label="Description">${highlightMatch(transaction.description, searchPattern)}</td>
        <td data-label="Amount" class="amount">${formattedAmount}</td>
        <td data-label="Category">${highlightMatch(transaction.category, searchPattern)}</td>
        <td data-label="Date">${formattedDate}</td>
        <td data-label="Action">
          <div class="action-buttons">
            <button class="edit-btn" onclick="editTransaction('${transaction.id}')">Edit</button>
            <button class="delete-btn" onclick="deleteTransaction('${transaction.id}')">Delete</button>
          </div>
        </td>
      `;

      return row;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Global functions for onclick handlers
    window.editTransaction = function (id) {
      const transaction = AppState.getTransaction(id);
      if (!transaction) return;

      // Populate form
      descriptionInput.value = transaction.description;
      document.getElementById('amount').value = transaction.amount;

      // Handle custom category
      const standardCategories = ['Food', 'Books', 'Transport', 'Entertainment', 'Fees'];
      if (standardCategories.includes(transaction.category)) {
        categorySelect.value = transaction.category;
        customCategoryInput.style.display = 'none';
      } else {
        categorySelect.value = 'Custom';
        customCategoryInput.style.display = 'block';
        customCategoryInput.value = transaction.category;
      }

      document.getElementById('date').value = transaction.date;
      editTransactionId.value = id;

      formTitle.textContent = 'Edit Transaction';
      formContainer.classList.add('active');

      // Scroll to form
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    window.deleteTransaction = function (id) {
      if (confirm('Are you sure you want to delete this transaction?')) {
        AppState.deleteTransaction(id);
        renderTransactions();
      }
    };
  </script>
</body>

</html>